<script>
  /******************************************
   * 0) INITIAL SETUP & GLOBALS
   ******************************************/
  let dropdownData = {
    sessions: [],
    trades: [],
    feesTypes: [],
    paymentModes: [],
  };

  // We'll store the data used in Class Dashboard
  let classMonthLineChartRef = null;
  let classMonthPieChartRef = null;
  let classMonthData = [];

  // Fopenr Analytics
  let dateWiseChartRef = null;
  let lineChartRef = null;
  let pieChartRef = null;

  // For Due Fees
  let dueFeesData = [];
  /******************************************
   * 0.0) COURSE PAYMENT
   ******************************************/

function getCourseDataByLocation(branch) {
  // console.log(branch);
  if (branch === "thane") {
    const courseData = {
      anm_nursing: { duration: "1 year", fees: 8500, total: 650 },
      gnm_nursing: { duration: "3 years", fees: 100000, total: 300000 }, // Fixed total (100000 * 3)
      dmlt: { duration: "1 year", fees: 700, total: 7000 }, // Fixed "1 years" to "1 year"
      ot_technician: { duration: "1 year", fees: 30000, total: 30000 },
      general_nursing: { duration: "1 year", fees: 30000, total: 3000 }, // Fixed "1 years" to "1 year"
    };
    return courseData;
  } else if (branch === "kurla") {
    const courseData = {
      anm_nursing: { duration: "1 year", fees: 65000, total: 6500 },
      gnm_nursing: { duration: "3 years", fees: 100000, total: 300000 }, // Fixed total (100000 * 3)
      dmlt: { duration: "1 year", fees: 70000, total: 70000 }, // Fixed "1 years" to "1 year"
      ot_technician: { duration: "1 year", fees: 30000, total: 30000 },
      general_nursing: { duration: "1 year", fees: 30000, total: 30000 }, // Fixed "1 years" to "1 year"
    };
    return courseData;
  } else if (branch === "nalasapora") {
    const courseData = {
      anm_nursing: { duration: "1 year", fees: 55000, total: 5500 },
      gnm_nursing: { duration: "3 years", fees: 90000, total: 270000 }, // Fixed total (90000 * 3)
      dmlt: { duration: "1 year", fees: 30000, total: 30000 }, // Fixed "1 years" to "1 year"
      ot_technician: { duration: "1 year", fees: 30000, total: 30000 },
      general_nursing: { duration: "1 year", fees: 30000, total: 30000 }, // Fixed "1 years" to "1 year"
    };
    return courseData;
  } else {
    const courseData = {
      anm_nursing: { duration: "1 year", fees: 60000, total: 60000 },
      gnm_nursing: { duration: "3 years", fees: 95000, total: 285000 }, // Fixed total (95000 * 3)
      dmlt: { duration: "1 year", fees: 55000, total: 55000 }, // Fixed fees and total from 55 to 55000
      ot_technician: { duration: "1 year", fees: 30000, total: 30000 },
      general_nursing: { duration: "1 year", fees: 30000, total: 30000 }, // Fixed "1 years" to "1 year"
    };
    return courseData;
  }
}

  let selectedCourse = null;
  let selectedPaymentType = "full";

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", function () {
    document
      .getElementById("coursePaySelect")
      .addEventListener("change", updateCoursePayDetails);
    selectPayment("full");
  });

  


  // Update course details when selection changes
  function updateCoursePayDetails() {
    

  const branch24 = document.getElementById("branch22").value;
  const courseData = getCourseDataByLocation(branch24);

    const select = document.getElementById("coursePaySelect");
    selectedCourse = select.value;

    if (selectedCourse && courseData[selectedCourse]) {
      const course = courseData[selectedCourse];

      // Update displayed information
      document.getElementById("courseDuration").textContent = course.duration;
      document.getElementById("coursePayFees").textContent = formatCurrency(
        course.fees
      );

      // Calculate total fees based on duration
      const years = course.duration.includes("year")
        ? parseInt(course.duration.split(" ")[0])
        : 1;
      const totalFees = years * course.fees;
      document.getElementById("totalFees").textContent =
        formatCurrency(totalFees);

      // Update all payment options
      updatePaymentOptions(totalFees);
    }
  }

  // Update all payment options with the current total fees
  function updatePaymentOptions(totalFees) {

        const branch24 = document.getElementById("branch22").value;
  const courseData = getCourseDataByLocation(branch24);

    // Full Payment
    const discount = totalFees * 0.05;
    const fullTotal = totalFees - discount;

    document.getElementById("fullCourseFees").textContent =
      formatCurrency(totalFees);
    document.getElementById("fullDiscount").textContent =
      formatCurrency(discount);
    document.getElementById("fullTotal").textContent =
      formatCurrency(fullTotal);

    // Partial Payment
    const partialInitial = Math.ceil(totalFees * 0.5);
    const partialRemaining = totalFees - partialInitial;
    const partialEMI = Math.ceil(partialRemaining / 6);

    document.getElementById("partialInitial").textContent =
      formatCurrency(partialInitial);
    document.getElementById("partialRemaining").textContent =
      formatCurrency(partialRemaining);
    document.getElementById("partialEMI").textContent =
      formatCurrency(partialEMI);

    // EMI Payment
    calculateEMI();
  }

  // Calculate EMI based on selected tenure
  function calculateEMI() {
        const branch24 = document.getElementById("branch22").value;
  const courseData = getCourseDataByLocation(branch24);

    if (!selectedCourse) return;

    const totalFees = getTotalFees();
    const tenure = parseInt(document.getElementById("emiTenure").value);
    const downPayment = Math.ceil(totalFees * 0.1); // 10% down payment
    const emiAmount = Math.ceil((totalFees - downPayment) / tenure);

    document.getElementById("emiDownPayment").textContent =
      formatCurrency(downPayment);
    document.getElementById("emiAmount").textContent =
      formatCurrency(emiAmount);
    document.getElementById("emiTotal").textContent = formatCurrency(totalFees);

    if (selectedPaymentType === "emi") {
      generateInstallmentSchedule(totalFees, downPayment, emiAmount, tenure);
    }
  }

  // Get total fees for selected course
  function getTotalFees() {
        const branch24 = document.getElementById("branch22").value;
  const courseData = getCourseDataByLocation(branch24);
    if (!selectedCourse) return 0;

    const course = courseData[selectedCourse];
    const years = course.duration.includes("year")
      ? parseInt(course.duration.split(" ")[0])
      : 1;

    return years * course.fees;
  }

  // Select payment type
  function selectPayment(type) {
    selectedPaymentType = type;

    // Update UI
    document.getElementById("fullPaymentCard").classList.remove("selected");
    document.getElementById("partialPaymentCard").classList.remove("selected");
    document.getElementById("emiPaymentCard").classList.remove("selected");

    document.getElementById(`${type}PaymentCard`).classList.add("selected");
    document.querySelector(`input[value="${type}"]`).checked = true;

    // Show/hide installment plan
    const installmentPlan = document.getElementById("installmentPlan");
    if (type === "emi" || type === "partial") {
      installmentPlan.classList.remove("hidden");

      const totalFees = getTotalFees();
      if (type === "emi") {
        calculateEMI();
      } else {
        // Partial payment installment schedule
        const initial = Math.ceil(totalFees * 0.5);
        const emiAmount = Math.ceil((totalFees - initial) / 6);
        generateInstallmentSchedule(totalFees, initial, emiAmount, 6);
      }
    } else {
      installmentPlan.classList.add("hidden");
    }
  }

  // Generate installment schedule
  function generateInstallmentSchedule(
    total,
    initialPayment,
    emiAmount,
    months
  ) {
    const table = document.getElementById("installmentTable");
    table.innerHTML = "";

    // Add initial payment row
    if (initialPayment > 0) {
      addInstallmentRow(table, 0, "Today", initialPayment, "Initial Payment");
    }

    // Add EMI rows
    const today = new Date();
    let remaining = total - initialPayment;

    for (let i = 1; i <= months; i++) {
      const dueDate = new Date();
      dueDate.setMonth(today.getMonth() + i);

      const amount = i === months ? remaining : emiAmount;
      remaining -= amount;

      addInstallmentRow(table, i, formatDate(dueDate), amount, "EMI");
    }
  }

  // Add row to installment table
  function addInstallmentRow(table, number, date, amount, type) {
    const row = document.createElement("tr");
    row.className = number % 2 === 0 ? "bg-gray-50" : "bg-white";

    row.innerHTML = `
          <td class="px-4 py-2 whitespace-nowrap">${
            number === 0 ? type : `Installment ${number}`
          }</td>
          <td class="px-4 py-2 whitespace-nowrap">${date}</td>
          <td class="px-4 py-2 whitespace-nowrap">${formatCurrency(amount)}</td>
          <td class="px-4 py-2 whitespace-nowrap">
            <span class="px-2 py-1 text-xs rounded-full ${
              number === 0
                ? "bg-blue-100 text-blue-800"
                : "bg-blue-50 text-blue-800"
            }">
              ${number === 0 ? "Due Now" : "Pending"}
            </span>
          </td>
        `;

    table.appendChild(row);
  }

  // Process payment (mock function)
  // function processPayment() {
  //   if (!selectedCourse) {
  //     alert("Please select a course first");
  //     return;
  //   }

  //   const paymentMethod = document.querySelector(
  //     'input[name="payment_method"]:checked'
  //   ).value;
  //   const amount = getPaymentAmount();

  //   alert(
  //     `Processing ${paymentMethod} payment of ${formatCurrency(amount)} for ${
  //       document.getElementById("coursePaySelect").selectedOptions[0].text
  //     }`
  //   );
  //   // In a real app, you would integrate with a payment gateway here
  // }

  // Get payment amount based on selected option
  function getPaymentAmount() {
    switch (selectedPaymentType) {
      case "full":
        return getTotalFees() * 0.95; // with 5% discount
      case "partial":
        return Math.ceil(getTotalFees() * 0.5); // 50% initial
      case "emi":
        return Math.ceil(getTotalFees() * 0.1); // 10% down payment
      default:
        return 0;
    }
  }

  // Helper function to format currency
  function formatCurrency(amount) {
    return "₹" + amount.toLocaleString("en-IN");
  }

  // Helper function to format date
  function formatDate(date) {
    return date.toLocaleDateString("en-IN", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    });
  }

  // Open course payment section
  function openCoursePayment() {
    hideAllSections();
    document.getElementById("coursePaymentSection").classList.remove("hidden");
  }

  /******************************************
   * 1) HELPER FUNCTIONS
   ******************************************/
  function hideAllSections() {
    document.getElementById("slipFormSection").classList.add("hidden");
    document.getElementById("oldFeesSection").classList.add("hidden");
    document.getElementById("analyticsSection").classList.add("hidden");
    document.getElementById("manageStudentSection").classList.add("hidden");
    document.getElementById("classMonthDashboard").classList.add("hidden");
    document.getElementById("dueFeesSection").classList.add("hidden");
    // document.getElementById("separateReceipt").classList.add("hidden");
    document.getElementById("ifId").classList.add("hidden");
    document.getElementById("admissionFormSection").classList.add("hidden");
    document.getElementById("coursePaymentSection").classList.add("hidden");
    document.getElementById("receiptReadOnlyForm").classList.add("hidden");
    document.getElementById("receiptReadOnlyForm").classList.add("hidden");
    document.getElementById("receiptR").classList.add("hidden");
    

  }
  function updateGeneratedTime() {
    const now = new Date();
    document.getElementById("generatedTime").innerText = now.toLocaleString();
  }

  // Convert any table to CSV / Copy / PDF
  function copyTable(containerId) {
    const container = document.getElementById(containerId);
    const table = container.querySelector("table");
    if (!table) return;
    let range = document.createRange();
    range.selectNode(table);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    try {
      document.execCommand("copy");
      Swal.fire({
        icon: "success",
        title: "Copied",
        text: "Table copied to clipboard.",
        timer: 1500,
        showConfirmButton: false,
      });
    } catch (err) {
      console.log(err);
    }
    window.getSelection().removeAllRanges();
  }

  function exportCSV(containerId, filename) {
    const container = document.getElementById(containerId);
    const table = container.querySelector("table");
    if (!table) return;
    let csv = [];
    const rows = table.querySelectorAll("tr");
    rows.forEach((row) => {
      const cols = row.querySelectorAll("td, th");
      let rowData = [];
      cols.forEach((col) => {
        // Escape quotes
        rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
      });
      csv.push(rowData.join(","));
    });
    const csvString = csv.join("\n");
    const blob = new Blob([csvString], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.setAttribute("hidden", "");
    a.setAttribute("href", url);
    a.setAttribute("download", filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  function exportTablePDF(containerId, title) {
    const container = document.getElementById(containerId);
    const table = container.querySelector("table");
    if (!table) return;
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML =
      `<h2 style="text-align:center;font-size:20px;margin-bottom:10px;">${title}</h2>` +
      table.outerHTML;
    const opt = {
      margin: 0.5,
      filename: title + ".pdf",
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
    };
    html2pdf().set(opt).from(tempDiv).save();
  }

  
  function copyInquiry() {
    sessionStorage.setItem(
      "tempText",
      document.getElementById("fullName").value
    );
    document.getElementById("student_name").value=sessionStorage.getItem("tempText");

    sessionStorage.setItem(
      "tempText2",
      document.getElementById("interestedCourse").value
    );
    document.getElementById("courseSelect").value=sessionStorage.getItem("tempText2");

    updateCourseDetails();
    updateYearPaymentOptions();
    updatePaymentFields();
    storePaymentType();
  }

  function copyAdmission(){
    // Name
        sessionStorage.setItem(
      "tempText3",
      document.getElementById("student_name").value
    );
    document.getElementById("std_Coursepayname").value=sessionStorage.getItem("tempText3");

    //ID
            sessionStorage.setItem(
      "tempText4",
      document.getElementById("receipt_number").value
    );
    document.getElementById("ID").value=sessionStorage.getItem("tempText4");

    //Courseselect
                sessionStorage.setItem(
      "tempText5",
      document.getElementById("courseSelect").value
    );
    document.getElementById("coursePaySelect").value=sessionStorage.getItem("tempText5");

    updateCoursePayDetails();
    updatePaymentOptions();

  }

function formatCurrency(amount) {
    return '₹' + parseFloat(amount).toLocaleString('en-IN', { minimumFractionDigits: 2 });
}

function generateReceipt() {
    try {
        const receiptNo = "REC" + Math.floor(1000 + Math.random() * 9000);
        const date = new Date().toLocaleDateString('en-GB');

        const studentName = document.getElementById('std_Coursepayname')?.value || "N/A";
        const courseSelect = document.getElementById('coursePaySelect');
        const courseName = courseSelect?.options[courseSelect.selectedIndex]?.text || "N/A";
        const totalAmountText = document.getElementById('totalFees')?.textContent || "₹0";
        const totalAmount = parseFloat(totalAmountText.replace(/[^0-9.]/g, ''));

        const paymentTypeEl = document.querySelector('input[name="Coursepayment_type"]:checked');
        const paymentType = paymentTypeEl?.value || "full";

        let paidAmount = 0;
        let balanceAmount = 0;

        if (paymentType === 'full') {
            const fullTotalText = document.getElementById('fullTotal')?.textContent || totalAmountText;
            paidAmount = parseFloat(fullTotalText.replace(/[^0-9.]/g, ''));
        } else if (paymentType === 'partial') {
            const partialInitialText = document.getElementById('partialInitial')?.textContent || (totalAmount * 0.5).toString();
            paidAmount = parseFloat(partialInitialText.replace(/[^0-9.]/g, ''));
        } else if (paymentType === 'emi') {
            const emiDownPaymentText = document.getElementById('emiDownPayment')?.textContent || (totalAmount * 0.1).toString();
            paidAmount = parseFloat(emiDownPaymentText.replace(/[^0-9.]/g, ''));
        }

        balanceAmount = totalAmount - paidAmount;
        // The paymentMethod field is not explicitly used in the new HTML structure, but kept for completeness if needed elsewhere.
        // const paymentMethod = document.getElementById('pay-select')?.value || "Cash";

        // Prepare data for the new HTML structure
        const receiptData = {
            receiptNo: receiptNo.replace('REC', ''), // Remove 'REC' prefix as per the target image
            date: date,
            fullName: studentName,
            proposeToPay: courseName,
            totalAmount: formatCurrency(totalAmount),
            paid: formatCurrency(paidAmount),
            balance: formatCurrency(balanceAmount),
            examFees: "-", // Hardcoded as per the provided HTML
            receivedBy: "Admin" // Hardcoded as per the provided HTML
        };

        // The entire HTML structure for the receipt, including internal CSS
        const receiptPageHTML = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Shelar Training Institute Receipt</title>
                <style>
                    @page {
                        size: A4;
                        margin: 0.5in;
                    }

                    body {
                        font-family: Arial, sans-serif;
                        margin: 0;
                        padding: 0;
                        background: white;
                    }

                    .page-container {
                        width: 210mm; /* A4 width */
                        height: 297mm; /* A4 height */
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        padding: 10mm;
                        box-sizing: border-box;
                    }

                    .receipt {
                        width: 100%;
                        height: 45%; /* Approximately half the page height for two receipts */
                        border: 3px solid #000;
                        border-radius: 15px;
                        padding: 15px;
                        box-sizing: border-box;
                        background: white;
                        margin-bottom: 10mm; /* Space between two receipts */
                    }

                    .header {
                        display: flex;
                        align-items: center;
                        margin-bottom: 15px;
                        border-bottom: 2px solid #000;
                        padding-bottom: 10px;
                    }

                    .logo {
                        width: 60px;
                        height: 60px;
                        background: #333;
                        border-radius: 50%;
                        margin-right: 15px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 24px;
                        font-weight: bold;
                    }

                    .institute-name {
                        font-size: 28px;
                        font-weight: bold;
                        color: #000;
                        flex-grow: 1;
                        letter-spacing: 1px;
                    }

                    .receipt-label {
                        background: #333;
                        color: white;
                        padding: 5px 15px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: bold;
                    }

                    .receipt-content {
                        display: flex;
                        flex-direction: column;
                        height: calc(100% - 100px); /* Adjust height based on header/footer */
                    }

                    .receipt-info {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 20px;
                    }

                    .receipt-no {
                        font-size: 16px;
                        font-weight: bold;
                    }

                    .date {
                        font-size: 16px;
                        font-weight: bold;
                    }

                    .form-fields {
                        flex-grow: 1;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }

                    .field-row {
                        display: flex;
                        align-items: center;
                        font-size: 14px;
                        font-weight: bold;
                    }

                    .field-label {
                        min-width: 140px;
                        color: #000;
                    }

                    .field-value {
                        flex-grow: 1;
                        border-bottom: 1px solid #000;
                        padding: 2px 5px;
                        min-height: 20px;
                        color: #0066cc; /* Color for dynamic values, adjust if needed */
                        /* Added styles for value overflow fix */
                        white-space: nowrap; /* Prevent text from wrapping by default */
                        overflow: hidden; /* Hide overflow content */
                        text-overflow: ellipsis; /* Add ellipsis for overflow */
                        max-width: calc(100% - 140px); /* Ensure it doesn't push the label too much */
                    }

                    .amount-fields {
                        display: flex;
                        gap: 20px;
                    }

                    .amount-field {
                        flex: 1;
                        /* Added min-width to ensure fields don't shrink too much */
                        min-width: 30%;
                    }
                    /* Adjust field-value specifically within amount-fields for better distribution */
                    .amount-fields .field-value {
                        max-width: none; /* Remove the general max-width constraint */
                        white-space: normal; /* Allow wrapping within amount fields */
                        word-break: break-all; /* Break long words if necessary */
                        flex-grow: 1;
                    }
                    .amount-fields .field-label {
                        min-width: 80px; /* Adjust label width for amount fields */
                    }

                    .footer {
                        margin-top: 15px;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-end;
                    }

                    .note {
                        font-size: 12px;
                        font-weight: bold;
                        max-width: 60%;
                    }

                    .signature-area {
                        text-align: center;
                        min-width: 150px;
                    }

                    .signature-line {
                        border-bottom: 1px solid #000;
                        height: 40px;
                        margin-bottom: 5px;
                    }

                    .signature-label {
                        font-size: 12px;
                        font-weight: bold;
                    }
                    /* Adjust for printing to ensure two receipts fit nicely */
                    @media print {
                        .page-container {
                            height: 297mm; /* Full A4 height */
                            padding: 0.5in; /* Match @page margin */
                        }
                        .receipt {
                            margin-bottom: 5mm; /* Slightly less margin for print */
                        }
                    }
                </style>
            </head>
            <body>
                <div class="page-container">
                    <!-- First Receipt -->
                    <div class="receipt">
                        <div class="header">
                            <div class="logo">S</div>
                            <div class="institute-name">SHELAR TRAINING INSTITUTE</div>
                            <div class="receipt-label">RECEIPT</div>
                        </div>

                        <div class="receipt-content">
                            <div class="receipt-info">
                                <div class="receipt-no">Receipt No. ${receiptData.receiptNo}</div>
                                <div class="date">Date: ${receiptData.date}</div>
                            </div>

                            <div class="form-fields">
                                <div class="field-row">
                                    <div class="field-label">Full Name :</div>
                                    <div class="field-value">${receiptData.fullName}</div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">Propose to Pay :</div>
                                    <div class="field-value">${receiptData.proposeToPay}</div>
                                </div>

                                <div class="field-row amount-fields">
                                    <div class="amount-field">
                                        <div class="field-row">
                                            <div class="field-label">Total Amount :</div>
                                            <div class="field-value">${receiptData.totalAmount}</div>
                                        </div>
                                    </div>
                                    <div class="amount-field">
                                        <div class="field-row">
                                            <div class="field-label">Paid :</div>
                                            <div class="field-value">${receiptData.paid}</div>
                                        </div>
                                    </div>
                                    <div class="amount-field">
                                        <div class="field-row">
                                            <div class="field-label">Balance Amount :</div>
                                            <div class="field-value">${receiptData.balance}</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">Exam Fees :</div>
                                    <div class="field-value">${receiptData.examFees}</div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">Received by :</div>
                                    <div class="field-value">${receiptData.receivedBy}</div>
                                </div>
                            </div>

                            <div class="footer">
                                <div class="note">• Once you pay fees for course not refundable.</div>
                                <div class="signature-area">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">Authority Signature</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Second Receipt (Copy) -->
                    <div class="receipt">
                        <div class="header">
                            <div class="logo">S</div>
                            <div class="institute-name">SHELAR TRAINING INSTITUTE</div>
                            <div class="receipt-label">RECEIPT</div>
                        </div>

                        <div class="receipt-content">
                            <div class="receipt-info">
                                <div class="receipt-no">Receipt No. ${receiptData.receiptNo}</div>
                                <div class="date">Date: ${receiptData.date}</div>
                            </div>

                            <div class="form-fields">
                                <div class="field-row">
                                    <div class="field-label">Full Name :</div>
                                    <div class="field-value">${receiptData.fullName}</div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">Propose to Pay :</div>
                                    <div class="field-value">${receiptData.proposeToPay}</div>
                                </div>

                                <div class="field-row amount-fields">
                                    <div class="amount-field">
                                        <div class="field-row">
                                            <div class="field-label">Total Amount :</div>
                                            <div class="field-value">${receiptData.totalAmount}</div>
                                        </div>
                                    </div>
                                    <div class="amount-field">
                                        <div class="field-row">
                                            <div class="field-label">Paid :</div>
                                            <div class="field-value">${receiptData.paid}</div>
                                        </div>
                                    </div>
                                    <div class="amount-field">
                                        <div class="field-row">
                                            <div class="field-label">Balance Amount :</div>
                                            <div class="field-value">${receiptData.balance}</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">Exam Fees :</div>
                                    <div class="field-value">${receiptData.examFees}</div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">Received by :</div>
                                    <div class="field-value">${receiptData.receivedBy}</div>
                                </div>
                            </div>

                            <div class="footer">
                                <div class="note">• Once you pay fees for course not refundable.</div>
                                <div class="signature-area">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">Authority Signature</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <script>
                    setTimeout(() => {
                        window.print();
                    }, 500);
                </scr` + `ipt>
            </body>
            </html>
        `;

        // Open a new tab and write the receipt
        const printWindow = window.open('', '_blank', 'width=800,height=1000');
        printWindow.document.write(receiptPageHTML); // Write the entire HTML string
        printWindow.document.close();

    } catch (error) {
        console.error("Error generating receipt:", error);
        // Using a custom message box instead of alert() for better user experience in an iframe environment
        const errorMessage = "Something went wrong. Please check the browser console for details.";
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffe0e0;
            border: 1px solid #ff0000;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            color: #cc0000;
            font-family: sans-serif;
            text-align: center;
        `;
        errorDiv.innerHTML = `
            <p>${errorMessage}</p>
            <button onclick="this.parentNode.remove()" style="margin-top: 15px; padding: 8px 15px; background-color: #ff0000; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
        `;
        document.body.appendChild(errorDiv);
    }
}



  document.getElementById("loginForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const loginData = {
    username: document.getElementById("loginUsername").value.trim(),
    password: document.getElementById("loginPassword").value.trim(),
  };

  google.script.run
    .withSuccessHandler(function (resp) {
      if (resp.success) {
        Swal.fire({
          icon: "success",
          title: "Login Successful",
          text: "Welcome, " + resp.userName,
          timer: 1500,
          showConfirmButton: false,
        });
      sessionStorage.setItem("loggedInUser", resp.userName);
       document.getElementById("loggedInUserId").value = resp.userName; 
        document.getElementById("userName").value = resp.userName;
        document.getElementById("userRole").value = resp.role;
        document.getElementById("userRoleDisplay").textContent = resp.role;
        document.getElementById("userBranch").value = resp.branch;

        
        document.getElementById("loggedInUserId").value = resp.userId;

        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("appSection").classList.remove("hidden");

        // Show Inquiry Form by default after login
        openInquiryForm();
        populateInquiryTakenBy();

        // Admin UI if role = admin
        if (resp.role === "admin") {
          document
            .getElementById("manageStudentsBtn")
            .classList.remove("hidden");
          document.getElementById("analyticsBtn").classList.remove("hidden");
          document
            .getElementById("classMonthDashboardBtn")
            .classList.remove("hidden");
          document.getElementById("dueFeesBtn").classList.remove("hidden");
        }

        // Load dropdown data
        google.script.run
          .withSuccessHandler(function (dd) {
            if (dd.error) {
              console.log("Dropdown error", dd.error);
              return;
            }
            dropdownData = dd;
            fillDropdowns();
          })
          .getDropdownData();
      } else {
        Swal.fire({
          icon: "error",
          title: "Login Failed",
          text: resp.error,
        });
      }
    })
    .loginUser(loginData);
});


function logout() {
  // Clear client-side UI immediately for responsiveness
  document.getElementById("appSection").classList.add("hidden");
  document.getElementById("loginSection").classList.remove("hidden");
  document.getElementById("loginUsername").value = "";
  document.getElementById("loginPassword").value = "";
  document.getElementById("loggedInUserId").value = "";
  sessionStorage.removeItem("loggedInUser"); // Clear client-side session storage too

  // Show a "logging out" message immediately
  Swal.fire({
    icon: "info",
    title: "Logging Out...",
    text: "Please wait.",
    allowOutsideClick: false,
    showConfirmButton: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });


  // ⭐⭐⭐ THIS IS THE CRUCIAL PART: Call the server-side function ⭐⭐⭐
  google.script.run
    .withSuccessHandler(function(resp) {
      // This code runs AFTER the server-side serverSideLogout() finishes successfully
      // The server-side function handles the actual logging to AuditLog sheet
      if (resp.success) {
        Swal.fire({
          icon: "info",
          title: "Logged Out",
          text: "You have been logged out.",
          timer: 1500, // Show for a short time
          showConfirmButton: false,
        });
      } else {
        // This case is less likely for logout, but good to have
        Swal.fire({
          icon: "error",
          title: "Logout Failed",
          text: "An error occurred during server-side logout.",
        });
      }
    })
    .withFailureHandler(function(error) {
      // This runs if there's an error calling the server-side function
      console.error("Error during server-side logout:", error);
      Swal.fire({
        icon: "error",
        title: "Logout Error",
        text: "Could not complete logout due to a system error. Check console.",
      });
    })
    .serverSideLogout(); // <--- This calls the server-side `serverSideLogout()` function
}

  /******************************************
   * 3) SLIP FORM: SUBMIT / UPDATE
   ******************************************/
  document
    .getElementById("receiptForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      submitFeeData();
    });

  function submitFeeData() {
    const formData = collectFormData();
    google.script.run
      .withSuccessHandler(function (resp) {
        if (resp.includes("Error")) {
          Swal.fire({ icon: "error", title: "Error", text: resp });
        } else {
          Swal.fire({
            icon: "success",
            title: "Saved",
            text: resp,
            timer: 1500,
            showConfirmButton: false,
          });
          document.getElementById("receiptForm").reset();
          document.getElementById("monthField").value = "";
          document.getElementById("recordRowNumber").value = "";
          document.getElementById("btnUpdateData").classList.add("hidden");
          document.getElementById("btnSubmitNew").classList.remove("hidden");
          updateGeneratedTime();
          showReceipt(formData); // Show receipt after successful submission
        }
      })
      .submitData(formData);
  }

  function updateFeeData() {
    const userRole = document.getElementById("userRole").value;
    const formData = collectFormData();
    google.script.run
      .withSuccessHandler(function (resp) {
        if (resp.includes("Error")) {
          Swal.fire({ icon: "error", title: "Update Error", text: resp });
        } else {
          Swal.fire({
            icon: "success",
            title: "Updated",
            text: resp,
            timer: 1500,
            showConfirmButton: false,
          });
          document.getElementById("receiptForm").reset();
          document.getElementById("monthField").value = "";
          document.getElementById("recordRowNumber").value = "";
          document.getElementById("btnUpdateData").classList.add("hidden");
          document.getElementById("btnSubmitNew").classList.remove("hidden");
          updateGeneratedTime();
          showReceipt(formData); // Show receipt after successful update
        }
      })
      .updateData(formData, userRole);
  }

  function collectFormData() {
    return {
      studentId: document.getElementById("studentId").value.trim(),
      date: document.getElementById("date").value.trim(),
      month: document.getElementById("monthField").value.trim(),
      session: document.getElementById("session").value.trim(),
      transactionId: document.getElementById("transactionId").value.trim(),
      trade: document.getElementById("trade").value.trim(),
      studentName: document.getElementById("studentName").value.trim(),
      fatherName: document.getElementById("fatherName").value.trim(),
      paidAmount: document.getElementById("paidAmount").value.trim(),
      paidAmountInWord: document
        .getElementById("paidAmountInWord")
        .value.trim(),
      feesType: document.getElementById("feesType").value.trim(),
      paymentMode: document.getElementById("paymentMode").value.trim(),
      remark: document.getElementById("remark").value.trim(),
      userName: document.getElementById("userName").value.trim(),
      recordRowNumber: document.getElementById("recordRowNumber").value.trim(),
    };
  }

  // Convert amount => words
  function numberToWords(num) {
    if (num === 0) return "zero";
    const a = [
      "",
      "one",
      "two",
      "three",
      "four",
      "five",
      "six",
      "seven",
      "eight",
      "nine",
      "ten",
      "eleven",
      "twelve",
      "thirteen",
      "fourteen",
      "fifteen",
      "sixteen",
      "seventeen",
      "eighteen",
      "nineteen",
    ];
    const b = [
      "",
      "",
      "twenty",
      "thirty",
      "forty",
      "fifty",
      "sixty",
      "seventy",
      "eighty",
      "ninety",
    ];
    const g = ["", "thousand", "million", "billion"];
    function grp(n) {
      let str = "";
      if (n > 99) {
        str += a[Math.floor(n / 100)] + " hundred ";
        n = n % 100;
      }
      if (n > 0) {
        if (n < 20) str += a[n] + " ";
        else str += b[Math.floor(n / 10)] + " " + a[n % 10] + " ";
      }
      return str;
    }
    let result = "";
    let j = 0;
    while (num > 0) {
      let n = num % 1000;
      if (n !== 0) result = grp(n) + g[j] + " " + result;
      num = Math.floor(num / 1000);
      j++;
    }
    return result.trim();
  }
  function convertAmountToWords() {
    const val = document.getElementById("paidAmount").value.trim();
    if (!val) {
      document.getElementById("paidAmountInWord").value = "";
      return;
    }
    const num = parseFloat(val);
    if (isNaN(num)) {
      document.getElementById("paidAmountInWord").value = "Invalid amount";
      return;
    }
    document.getElementById("paidAmountInWord").value = numberToWords(
      Math.floor(num)
    );
  }
  function updateMonthField() {
    const dVal = document.getElementById("date").value;
    if (dVal) {
      const dObj = new Date(dVal);
      const shortM = dObj.toLocaleString("en-US", { month: "short" });
      document.getElementById("monthField").value = shortM;
    } else {
      document.getElementById("monthField").value = "";
    }
  }

  /******************************************
   * 4) SEARCHING STUDENT & OLD FEES
   ******************************************/
  function searchBySideBar() {
    const sid = document.getElementById("sideBarSearchId").value.trim();
    if (!sid) {
      Swal.fire({
        icon: "info",
        title: "Enter Student ID",
        text: "Please type a Student ID",
      });
      return;
    }
    fetchStudentSession(sid);
  }
  function fetchStudentSession(studentId) {
    google.script.run
      .withSuccessHandler(function (resp) {
        if (resp.error) {
          Swal.fire({ icon: "error", title: "Error", text: resp.error });
        } else {
          document.getElementById("studentId").value = studentId;
          document.getElementById("session").value = resp.session;
          document.getElementById("studentName").value = resp.studentName;
          document.getElementById("fatherName").value = resp.fatherName;
          document.getElementById("trade").value = resp.trade;

          // auto date => today
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth() + 1).padStart(2, "0");
          const dd = String(today.getDate()).padStart(2, "0");
          document.getElementById("date").value = `${yyyy}-${mm}-${dd}`;
          updateMonthField();

          document.getElementById("recordRowNumber").value = "";
          document.getElementById("btnUpdateData").classList.add("hidden");
          document.getElementById("btnSubmitNew").classList.remove("hidden");
          updateGeneratedTime();
          Swal.fire({
            icon: "success",
            title: "Student Loaded",
            timer: 1000,
            showConfirmButton: false,
          });
        }
      })
      .getStudentSession(studentId);
  }
  function searchOldFees() {
    const sid = prompt("Enter Student ID for Old Fees:");
    if (!sid) return;
    google.script.run
      .withSuccessHandler(function (resp) {
        if (resp.error) {
          Swal.fire({ icon: "error", title: "Error", text: resp.error });
        } else {
          let tbl = "";
          if (!resp.length) {
            tbl = `<tr><td colspan='5' class='px-4 py-2 text-center'>No old fee records found.</td></tr>`;
          } else {
            resp.forEach((r) => {
              tbl += `<tr>
                 <td class='px-4 py-2'>${r.date}</td>
                 <td class='px-4 py-2'>${r.month}</td>
                 <td class='px-4 py-2'>${r.paidAmount}</td>
                 <td class='px-4 py-2'>${r.transactionId}</td>
                 <td class='px-4 py-2'><button class='bg-blue-500 text-white px-2 py-1 rounded' onclick='viewRecord(${r.row})'>Get</button></td>
               </tr>`;
            });
          }
          document.getElementById("oldFeesTable").innerHTML = tbl;
          hideAllSections();
          document.getElementById("oldFeesSection").classList.remove("hidden");
        }
      })
      .getOldFees(sid);
  }
  // "View Old Slips" from Slip form
  function searchOldFeesFromSlip() {
    const sid = document.getElementById("studentId").value.trim();
    if (!sid) {
      Swal.fire({
        icon: "warning",
        title: "Enter Student ID",
        text: "Please type a Student ID first.",
      });
      return;
    }
    google.script.run
      .withSuccessHandler(function (resp) {
        if (resp.error) {
          Swal.fire({ icon: "error", title: "Error", text: resp.error });
        } else {
          let tbl = "";
          if (!resp.length) {
            tbl = `<tr><td colspan='5' class='px-4 py-2 text-center'>No old fee records found.</td></tr>`;
          } else {
            resp.forEach((r) => {
              tbl += `<tr>
                 <td class='px-4 py-2'>${r.date}</td>
                 <td class='px-4 py-2'>${r.month}</td>
                 <td class='px-4 py-2'>${r.paidAmount}</td>
                 <td class='px-4 py-2'>${r.transactionId}</td>
                 <td class='px-4 py-2'><button class='bg-blue-500 text-white px-2 py-1 rounded' onclick='viewRecord(${r.row})'>Get</button></td>
               </tr>`;
            });
          }
          document.getElementById("oldFeesTable").innerHTML = tbl;
          hideAllSections();
          document.getElementById("oldFeesSection").classList.remove("hidden");
        }
      })
      .getOldFees(sid);
  }
  function backToInquiryForm() {
    hideAllSections();
    document.getElementById("ifId").classList.remove("hidden");
  }
  function viewRecord(rowNumber) {
    google.script.run
      .withSuccessHandler(function (resp) {
        if (resp.error) {
          Swal.fire({ icon: "error", title: "Error", text: resp.error });
        } else {
          const vals = resp.values;
          document.getElementById("studentId").value = vals[0] || "";
          document.getElementById("date").value = vals[1] || "";
          document.getElementById("monthField").value = vals[2] || "";
          document.getElementById("session").value = vals[3] || "";
          document.getElementById("transactionId").value = vals[4] || "";
          document.getElementById("trade").value = vals[5] || "";
          document.getElementById("studentName").value = vals[6] || "";
          document.getElementById("fatherName").value = vals[7] || "";
          document.getElementById("paidAmount").value = vals[8] || "";
          document.getElementById("paidAmountInWord").value = vals[9] || "";
          document.getElementById("feesType").value = vals[10] || "";
          document.getElementById("paymentMode").value = vals[11] || "";
          document.getElementById("remark").value = vals[12] || "";
          document.getElementById("userName").value = vals[13] || "";
          document.getElementById("recordRowNumber").value = rowNumber;

          const role = document.getElementById("userRole").value;
          if (role === "admin") {
            document.getElementById("btnUpdateData").classList.remove("hidden");
            document.getElementById("btnSubmitNew").classList.add("hidden");
          } else {
            document.getElementById("btnUpdateData").classList.add("hidden");
            document.getElementById("btnSubmitNew").classList.remove("hidden");
          }
          backToSlipForm();
        }
      })
      .getRecord(rowNumber);
  }

  /******************************************
   * 5) PDF DOWNLOAD
   ******************************************/
  function downloadPDF() {
    const element = document.getElementById("slipFormSection");
    const opt = {
      margin: 0.5,
      filename: "FeeSlip.pdf",
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
    };
    html2pdf()
      .set(opt)
      .from(element)
      .save()
      .then(() => {
        Swal.fire({
          icon: "success",
          title: "PDF Downloaded",
          text: "Fee slip PDF downloaded.",
          timer: 1500,
          showConfirmButton: false,
        });
      });
  }

  /******************************************
   * 6) ANALYTICS
   ******************************************/
  function toggleAnalytics() {
    hideAllSections();
    document.getElementById("analyticsSection").classList.remove("hidden");
    loadAnalytics();
  }
  function backToInquiryFromAnalytics() {
    hideAllSections();
    document.getElementById("ifId").classList.remove("hidden");
  }
  function clearAnalyticsFilter() {
    document.getElementById("analyticsDateFrom").value = "";
    document.getElementById("analyticsDateTo").value = "";
    document.getElementById("analyticsMonthFilter").value = "";
    document.getElementById("analyticsFeesTypeFilter").value = "";
    document.getElementById("analyticsPaymentModeFilter").value = "";
    loadAnalytics();
  }
  function loadAnalytics() {
    const userRole = document.getElementById("userRole").value;
    const monthFilter = document
      .getElementById("analyticsMonthFilter")
      .value.trim();
    const feesTypeFilter = document
      .getElementById("analyticsFeesTypeFilter")
      .value.trim();
    const paymentModeFilter = document
      .getElementById("analyticsPaymentModeFilter")
      .value.trim();
    const dateFrom = document.getElementById("analyticsDateFrom").value.trim();
    const dateTo = document.getElementById("analyticsDateTo").value.trim();

    google.script.run
      .withSuccessHandler(function (an) {
        if (an.error) {
          Swal.fire({
            icon: "error",
            title: "Analytics Error",
            text: an.error,
          });
          return;
        }

        document.getElementById("cardTotalPaid").textContent =
          an.totalPaidFees.toFixed(2);
        document.getElementById("cardTotalUnpaid").textContent =
          an.totalUnpaidFees.toFixed(2);
        document.getElementById("cardTotalStudents").textContent =
          an.totalStudents;
        document.getElementById("cardPaidStudents").textContent =
          an.paidStudentsCount;
        document.getElementById("cardUnpaidStudents").textContent =
          an.unpaidStudentsCount;

        const dateLabels = Object.keys(an.dateWisePaid).sort();
        const dateVals = dateLabels.map((d) => an.dateWisePaid[d]);

        // Bar Chart
        if (dateWiseChartRef) dateWiseChartRef.destroy();
        const ctxBar = document
          .getElementById("dateWiseChart")
          .getContext("2d");
        dateWiseChartRef = new Chart(ctxBar, {
          type: "bar",
          data: {
            labels: dateLabels,
            datasets: [
              {
                label: "Fees Paid",
                data: dateVals,
                backgroundColor: "rgba(54, 162, 235, 0.6)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: { responsive: true, scales: { y: { beginAtZero: true } } },
        });

        // Line Chart
        const lineLabels = Object.keys(an.lineData).sort();
        const lineVals = lineLabels.map((d) => an.lineData[d]);
        if (lineChartRef) lineChartRef.destroy();
        const ctxLine = document.getElementById("lineChart").getContext("2d");
        lineChartRef = new Chart(ctxLine, {
          type: "line",
          data: {
            labels: lineLabels,
            datasets: [
              {
                label: "Fees Trend",
                data: lineVals,
                fill: false,
                borderColor: "rgba(255,99,132,1)",
                tension: 0.1,
              },
            ],
          },
          options: { responsive: true },
        });

        // Pie Chart
        if (pieChartRef) pieChartRef.destroy();
        const ctxPie = document.getElementById("pieChart").getContext("2d");
        pieChartRef = new Chart(ctxPie, {
          type: "pie",
          data: {
            labels: ["Paid", "Unpaid"],
            datasets: [
              {
                data: [an.pieData.paid, an.pieData.unpaid],
                backgroundColor: ["#4CAF50", "#FF9800"],
              },
            ],
          },
          options: { responsive: true },
        });
      })
      .getAnalyticsData(
        monthFilter,
        feesTypeFilter,
        paymentModeFilter,
        dateFrom,
        dateTo,
        userRole
      );
  }

  /******************************************
   * 7) MANAGE STUDENTS
   ******************************************/
  function toggleManageStudents() {
    hideAllSections();
    document.getElementById("manageStudentSection").classList.remove("hidden");
    loadStudentList();
  }
  function loadStudentList() {
    google.script.run
      .withSuccessHandler(function (studs) {
        if (studs.error) {
          Swal.fire({ icon: "error", title: "Error", text: studs.error });
          return;
        }
        let h = `<table class='min-w-full'>
           <thead class='bg-gray-50'>
             <tr>
               <th class='px-4 py-2 text-left'>Student ID</th>
               <th class='px-4 py-2 text-left'>Session</th>
               <th class='px-4 py-2 text-left'>Name</th>
               <th class='px-4 py-2 text-left'>Course</th>
               <th class='px-4 py-2 text-left'>Class</th>
               <th class='px-4 py-2 text-left'>Total Fees</th>
               <th class='px-4 py-2 text-left'>Actions</th>
             </tr>
           </thead><tbody>`;
        studs.forEach((s) => {
          h += `<tr class='border-b'>
             <td class='px-4 py-2'>${s.studentId}</td>
             <td class='px-4 py-2'>${s.session}</td>
             <td class='px-4 py-2'>${s.studentName}</td>
             <td class='px-4 py-2'>${s.trade}</td>
             <td class='px-4 py-2'>${s.className}</td>
             <td class='px-4 py-2'>${s.totalFees}</td>
             <td class='px-4 py-2'>
               <button class='bg-blue-500 text-white px-2 py-1 rounded mr-2' onclick='editStudent(${JSON.stringify(
                 s
               )})'>Edit</button>
               <button class='bg-red-500 text-white px-2 py-1 rounded' onclick='deleteStudent(${
                 s.row
               })'>Delete</button>
             </td>
           </tr>`;
        });
        h += "</tbody></table>";
        document.getElementById("studentTableContainer").innerHTML = h;
      })
      .getStudentList();
  }
  function openStudentModal(mode, stud) {
    document.getElementById("studentModal").classList.remove("hidden");
    if (mode === "add") {
      document.getElementById("studentModalTitle").innerText = "Add Student";
      document.getElementById("studentModalBtn").innerText = "Add Student";
      document.getElementById("studentForm").reset();
      document.getElementById("studentRow").value = "";
    } else if (mode === "edit") {
      document.getElementById("studentModalTitle").innerText = "Edit Student";
      document.getElementById("studentModalBtn").innerText = "Update Student";
      document.getElementById("studentRow").value = stud.row;
      document.getElementById("studentIdNew").value = stud.studentId;
      document.getElementById("sessionNew").value = stud.session;
      document.getElementById("tradeNew").value = stud.trade;
      document.getElementById("studentNameNew").value = stud.studentName;
      document.getElementById("fatherNameNew").value = stud.fatherName;
      document.getElementById("instituteNameNew").value = stud.instituteName;
      document.getElementById("classNameNew").value = stud.className;
      document.getElementById("totalFeesNew").value = stud.totalFees;
    }
  }
  function closeStudentModal() {
    document.getElementById("studentModal").classList.add("hidden");
  }
  document
    .getElementById("studentForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      const userRole = document.getElementById("userRole").value;
      const sData = {
        studentId: document.getElementById("studentIdNew").value.trim(),
        session: document.getElementById("sessionNew").value.trim(),
        trade: document.getElementById("tradeNew").value.trim(),
        studentName: document.getElementById("studentNameNew").value.trim(),
        fatherName: document.getElementById("fatherNameNew").value.trim(),
        instituteName: document.getElementById("instituteNameNew").value.trim(),
        className: document.getElementById("classNameNew").value.trim(),
        totalFees: document.getElementById("totalFeesNew").value.trim(),
      };
      const row = document.getElementById("studentRow").value.trim();

      if (row) {
        // update
        sData.row = row;
        google.script.run
          .withSuccessHandler(function (resp) {
            if (resp.includes("Error")) {
              Swal.fire({ icon: "error", title: "Update Error", text: resp });
            } else {
              Swal.fire({
                icon: "success",
                title: "Updated",
                text: resp,
                timer: 1500,
                showConfirmButton: false,
              });
              closeStudentModal();
              loadStudentList();
            }
          })
          .updateStudentData(sData, userRole);
      } else {
        // add
        google.script.run
          .withSuccessHandler(function (resp) {
            if (resp.includes("Error")) {
              Swal.fire({ icon: "error", title: "Add Error", text: resp });
            } else {
              Swal.fire({
                icon: "success",
                title: "Student Added",
                text: resp,
                timer: 1500,
                showConfirmButton: false,
              });
              closeStudentModal();
              loadStudentList();
            }
          })
          .addStudentData(sData, userRole);
      }
    });
  function editStudent(stud) {
    openStudentModal("edit", stud);
  }
  function deleteStudent(rowNumber) {
    const ur = document.getElementById("userRole").value;
    Swal.fire({
      icon: "warning",
      title: "Are you sure?",
      text: "This will delete the student record.",
      showCancelButton: true,
      confirmButtonText: "Yes, delete",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler(function (resp) {
            if (resp.includes("Error")) {
              Swal.fire({ icon: "error", title: "Delete Error", text: resp });
            } else {
              Swal.fire({
                icon: "success",
                title: "Deleted",
                text: resp,
                timer: 1500,
                showConfirmButton: false,
              });
              loadStudentList();
            }
          })
          .deleteStudentData(rowNumber, ur);
      }
    });
  }
  function filterStudentList() {
    const input = document
      .getElementById("studentSearchInput")
      .value.toLowerCase();
    const table = document
      .getElementById("studentTableContainer")
      .getElementsByTagName("table")[0];
    if (!table) return;
    const tr = table.getElementsByTagName("tr");
    for (let i = 1; i < tr.length; i++) {
      const rowTxt = tr[i].textContent.toLowerCase();
      tr[i].style.display = rowTxt.indexOf(input) > -1 ? "" : "none";
    }
  }

  /******************************************
   * 8) CLASS & MONTH DASHBOARD
   ******************************************/
  function toggleClassMonthDashboard() {
    hideAllSections();
    document.getElementById("classMonthDashboard").classList.remove("hidden");
    loadClassList();
  }
  function backToInquiryFromClassDashboard() {
    hideAllSections();
    document.getElementById("ifId").classList.remove("hidden");
  }
  function loadClassList() {
    google.script.run
      .withSuccessHandler(function (cls) {
        const sel = document.getElementById("selectClass");
        sel.innerHTML = `<option value="">All Classes</option>`;
        if (cls.error) {
          console.log(cls.error);
          return;
        }
        cls.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          sel.appendChild(opt);
        });
      })
      .getClassList();
  }
  function loadClassMonthDashboard() {
    const sc = document.getElementById("selectClass").value;
    const sm = document.getElementById("selectMonth").value;
    const ur = document.getElementById("userRole").value;
    google.script.run
      .withSuccessHandler(function (res) {
        if (res.error) {
          Swal.fire({ icon: "error", title: "Error", text: res.error });
          return;
        }
        // line chart
        if (classMonthLineChartRef) classMonthLineChartRef.destroy();
        const ctx = document
          .getElementById("classMonthLineChart")
          .getContext("2d");
        const dLabels = Object.keys(res.lineData);
        const dVals = dLabels.map((d) => res.lineData[d]);
        classMonthLineChartRef = new Chart(ctx, {
          type: "line",
          data: {
            labels: dLabels,
            datasets: [
              {
                label: "Fees Paid",
                data: dVals,
                borderColor: "rgba(75,192,192,1)",
                fill: false,
                tension: 0.1,
              },
            ],
          },
          options: { responsive: true, scales: { y: { beginAtZero: true } } },
        });

        // store data to do client-side filtering
        classMonthData = res.students;

        // build table
        const tb = document.getElementById("classMonthStudentTable");
        tb.innerHTML = "";
        res.students.forEach((s) => {
          const paidTxt = s.hasPaid ? "Yes" : "No";
          tb.innerHTML += `<tr>
             <td class='px-4 py-2'>${s.studentId}</td>
             <td class='px-4 py-2'>${s.studentName}</td>
             <td class='px-4 py-2'>${paidTxt}</td>
           </tr>`;
        });

        updateClassMonthPieChart();
        filterClassMonthTable(); // apply filters immediately
      })
      .getClassMonthDashboard(sc, sm, ur);
  }
  // Filter paid/unpaid + student search client-side
  function filterClassMonthTable() {
    const selectPaid = document.getElementById("selectPaidStatus").value;
    const searchVal = document
      .getElementById("classMonthSearchInput")
      .value.toLowerCase();
    const rows = document
      .getElementById("classMonthStudentTable")
      .getElementsByTagName("tr");
    for (let i = 0; i < rows.length; i++) {
      let cols = rows[i].getElementsByTagName("td");
      if (cols.length < 3) continue;
      let studentId = cols[0].textContent.toLowerCase();
      let studentName = cols[1].textContent.toLowerCase();
      let paidCol = cols[2].textContent.toLowerCase(); // "yes" or "no"

      // check search
      if (
        studentId.indexOf(searchVal) === -1 &&
        studentName.indexOf(searchVal) === -1
      ) {
        rows[i].style.display = "none";
        continue;
      }
      // check paid status
      if (selectPaid === "paid" && paidCol !== "yes") {
        rows[i].style.display = "none";
      } else if (selectPaid === "unpaid" && paidCol !== "no") {
        rows[i].style.display = "none";
      } else {
        rows[i].style.display = "";
      }
    }
    updateClassMonthPieChart();
  }

  function updateClassMonthPieChart() {
    // count paid vs. unpaid in classMonthData (but also consider search filter if we want)
    // For simplicity, we recalc from the array because it's easy:
    let paidCount = 0,
      unpaidCount = 0;

    // We'll also check what is currently visible in the table:
    const rows = document
      .getElementById("classMonthStudentTable")
      .getElementsByTagName("tr");
    for (let i = 0; i < rows.length; i++) {
      if (rows[i].style.display === "none") continue; // skip hidden
      let cols = rows[i].getElementsByTagName("td");
      if (cols.length < 3) continue;
      let paidCol = cols[2].textContent.toLowerCase();
      if (paidCol === "yes") paidCount++;
      else unpaidCount++;
    }

    if (classMonthPieChartRef) classMonthPieChartRef.destroy();
    const ctxPie = document
      .getElementById("classMonthPieChart")
      .getContext("2d");
    classMonthPieChartRef = new Chart(ctxPie, {
      type: "pie",
      data: {
        labels: ["Paid", "Unpaid"],
        datasets: [
          {
            data: [paidCount, unpaidCount],
            backgroundColor: ["#4CAF50", "#FF9800"],
          },
        ],
      },
      options: { responsive: true },
    });
  }

  /******************************************
   * 9) DUE FEES
   ******************************************/
  function toggleDueFees() {
    hideAllSections();
    document.getElementById("dueFeesSection").classList.remove("hidden");
    // Load class list for filter
    google.script.run
      .withSuccessHandler(function (cls) {
        const sel = document.getElementById("dueFeesClassSelect");
        sel.innerHTML = `<option value="">All Classes</option>`;
        if (cls.error) {
          console.log(cls.error);
        } else {
          cls.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            sel.appendChild(opt);
          });
        }
      })
      .getClassList();
    loadDueFees();
  }
  function closeDueFees() {
    hideAllSections();
    document.getElementById("ifId").classList.remove("hidden");
  }
  function loadDueFees() {
    const userRole = document.getElementById("userRole").value;
    google.script.run
      .withSuccessHandler(function (res) {
        if (res.error) {
          Swal.fire({
            icon: "error",
            title: "Due Fees Error",
            text: res.error,
          });
          return;
        }
        document.getElementById("dueTotalFees").textContent =
          res.summary.totalFees;
        document.getElementById("dueTotalPaid").textContent =
          res.summary.totalPaid;
        document.getElementById("dueTotalDue").textContent =
          res.summary.totalDue;
        document.getElementById("dueFullyPaidCount").textContent =
          res.summary.fullyPaidCount;

        dueFeesData = res.data; // store globally
        renderDueFeesTable(dueFeesData);
      })
      .getDueFeesData(userRole);
  }
  function renderDueFeesTable(dataArray) {
    let h = `<table class='min-w-full'>
         <thead class='bg-gray-50'>
           <tr>
             <th class='px-4 py-2 text-left'>Student ID</th>
             <th class='px-4 py-2 text-left'>Name</th>
             <th class='px-4 py-2 text-left'>Class</th>
             <th class='px-4 py-2 text-left'>Total Fees</th>
             <th class='px-4 py-2 text-left'>Paid</th>
             <th class='px-4 py-2 text-left'>Due</th>
           </tr>
         </thead><tbody>`;
    dataArray.forEach((d) => {
      h += `<tr class='border-b'>
           <td class='px-4 py-2'>${d.studentId}</td>
           <td class='px-4 py-2'>${d.studentName}</td>
           <td class='px-4 py-2'>${d.className}</td>
           <td class='px-4 py-2'>${d.totalFees}</td>
           <td class='px-4 py-2'>${d.sumPaid}</td>
           <td class='px-4 py-2 text-red-600'>${d.dueFees}</td>
         </tr>`;
    });
    h += "</tbody></table>";
    document.getElementById("dueFeesTableContainer").innerHTML = h;
  }
  function filterDueFees() {
    const inputVal = document
      .getElementById("dueFeesSearch")
      .value.toLowerCase();
    const classVal = document
      .getElementById("dueFeesClassSelect")
      .value.toLowerCase();

    const filtered = dueFeesData.filter((d) => {
      // match search (across ID, name, fatherName, class, etc.)
      let rowText = (
        d.studentId +
        " " +
        d.studentName +
        " " +
        d.fatherName +
        " " +
        d.className
      ).toLowerCase();
      if (rowText.indexOf(inputVal) === -1) return false;

      // match class filter
      if (classVal && d.className.toLowerCase() !== classVal) return false;

      return true;
    });
    renderDueFeesTable(filtered);
  }











  /******************************************
   * 6) admission receipt
   ******************************************/

// function openReceiptReadOnlyForm() {
//   hideAllSections(); // Your existing function
//   const section = document.getElementById("receiptReadOnlyForm");
//   if (section) section.classList.remove("hidden");

//   // Get auto-generated receipt number from Apps Script
//   google.script.run.withSuccessHandler(function(receiptNumber) {
//     document.getElementById("receiptNoForm").value = receiptNumber;
//   }).generateReceiptNumber();
// } 



  // function downloadAdmissionReceiptPDF() {
  //   // Clone the receipt element twice
  //   const receipt = document.querySelector(".receipt");
  //   const clone1 = receipt.cloneNode(true);
  //   const clone2 = receipt.cloneNode(true);

  //   // Remove button from clones if present
  //   clone1.querySelector(".no-print")?.remove();
  //   clone2.querySelector(".no-print")?.remove();

  //   // Create a wrapper for the PDF content
  //   const container = document.createElement("div");
  //   container.style.width = "210mm";
  //   container.style.minHeight = "297mm";
  //   container.style.padding = "10mm";
  //   container.style.boxSizing = "border-box";
  //   container.style.background = "white";

  //   // Style both receipts
  //   clone1.style.marginBottom = "20px";
  //   container.appendChild(clone1);
  //   container.appendChild(clone2);

  //   // Convert to PDF
  //   html2pdf()
  //     .from(container)
  //     .set({
  //       margin: 0,
  //       filename: 'Admission_Receipt.pdf',
  //       image: { type: 'jpeg', quality: 0.98 },
  //       html2canvas: { scale: 2, useCORS: true },
  //       jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  //     })
  //     .save();
  // }
// <!-- 
// function downloadAdmissionReceiptPDF() {
//   const receipt = document.querySelector(".receipt");
//   const clone1 = receipt.cloneNode(true);
//   const clone2 = receipt.cloneNode(true);

//   // Remove download buttons from PDF
//   clone1.querySelector(".no-print")?.remove();
//   clone2.querySelector(".no-print")?.remove();

//   // Scale to fit both receipts
//   clone1.style.transform = "scale(0.95)";
//   clone1.style.transformOrigin = "top left";
//   clone2.style.transform = "scale(0.95)";
//   clone2.style.transformOrigin = "top left";

//   // Create wrapper
//   const container = document.createElement("div");
//   container.style.width = "210mm";
//   container.style.height = "297mm"; // Use exact A4 height
//   container.style.padding = "10mm";
//   container.style.boxSizing = "border-box";
//   container.style.background = "white";
//   container.style.overflow = "hidden";

//   // Add both receipts
//   container.appendChild(clone1);
//   container.appendChild(clone2);

//   // Generate PDF
//   html2pdf()
//     .from(container)
//     .set({
//       margin: 0,
//       filename: 'Admission_Receipt.pdf',
//       image: { type: 'jpeg', quality: 0.98 },
//       html2canvas: { scale: 2, useCORS: true },
//       jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
//     })
//     .save();
// } -->

 function downloadAdmissionReceiptPDF() {
  const receipt = document.querySelector(".receipt");
  const clone1 = receipt.cloneNode(true);
  const clone2 = receipt.cloneNode(true);

  // Remove download buttons from PDF
  clone1.querySelector(".no-print")?.remove();
  clone2.querySelector(".no-print")?.remove();
// Scale to fit both receipts
clone1.style.transform = "scale(0.94)";
clone1.style.transformOrigin = "top left";
clone2.style.transform = "scale(0.94)";
clone2.style.transformOrigin = "top left";

// Create wrapper
const container = document.createElement("div");
container.style.width = "210mm";
container.style.height = "297mm"; // A4
container.style.padding = "6mm"; // Slight padding
container.style.boxSizing = "border-box";
container.style.background = "white";
container.style.overflow = "hidden";

// Create dashed line
const dashedLine = document.createElement("hr");
dashedLine.style.borderTop = "2px dashed black";
dashedLine.style.margin = "12px 0";

// Append receipts with dashed line between
container.appendChild(clone1);
container.appendChild(dashedLine);
container.appendChild(clone2);

// Generate PDF
html2pdf()
  .from(container)
  .set({
    margin: 0,
    filename: 'Admission_Receipt.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  })
  .save();
 }



 
function openReceiptReadOnlyForm() {
   hideAllSections(); // Your existing function
  const section = document.getElementById("receiptReadOnlyForm");
  if (section) section.classList.remove("hidden");

  // Get auto-generated receipt number from Apps Script
  google.script.run.withSuccessHandler(function(receiptNumber) {
    document.getElementById("receiptNoForm").value = receiptNumber;
  }).generateReceiptNumber();
  // Get values from admission form
  const name = document.getElementById("Student_namee").value || "";
  const receipt = document.getElementById("receipt_number").value || "";
  const course = document.getElementById("courseSelect").value || "";
  const courseText = document.querySelector("#courseSelect option:checked")?.textContent || "";
  const fees = document.getElementById("courseFeeees").value || "";
  const paid = getPaidAmount();  // If paid amount is dynamic
  const balance = parseInt(fees || 0) - parseInt(paid || 0);
  const duration = document.getElementById("coursePeriod").value || "";
  const examFees = 6000;
  const receivedBy = "Admin";

  // Fill into receipt <span> fields
  document.getElementById("student_name_display").textContent = name;
  document.getElementById("receipt_no_display").textContent = receipt;
  document.getElementById("propose_to_pay_display").textContent = courseText + " Admission Fee";
  document.getElementById("total_amount_display").textContent = fees;
  document.getElementById("paid_amount_display").textContent = paid;
  document.getElementById("balance_display").textContent = balance || 0;
  document.getElementById("exam_fees_display").textContent = examFees;
  document.getElementById("received_by_display").textContent = receivedBy;

  // Show the receipt section
  document.getElementById("receiptReadOnlyForm").classList.remove("hidden");
  document.getElementById("admissionFormSection").classList.add("hidden");
}

function getPaidAmount() {
  // Use this if your form allows EMI or partial
  const yearPayments = document.querySelectorAll(".year-paid-input");
  let totalPaid = 0;
  yearPayments.forEach(inp => {
    const value = parseInt(inp.value || 0);
    if (!isNaN(value)) totalPaid += value;
  });
  return totalPaid;
}

  /******************************************
   * 10) RECEIPT PRINTING
   ******************************************/
  let lastReceiptData = null;

  function showReceipt(data) {
    try {
      // Store the data for later access
      lastReceiptData = data;

      // Fill receipt data
      document.getElementById("receiptNumber").textContent =
        data.transactionId || "N/A";
      document.getElementById("receiptDate").textContent = data.date
        ? formatDate(data.date)
        : "________________";
      document.getElementById("receiptStudentName").textContent =
        data.studentName || "Not Provided";
      document.getElementById("receiptCourse").textContent =
        data.trade || "Not Specified";

      // Format currency
      const formatCurrency = (val) =>
        val ? "₹" + parseFloat(val).toFixed(2) : "₹0.00";
      document.getElementById("receiptTotalAmount").textContent =
        formatCurrency(data.totalFees || 0);
      document.getElementById("receiptPaidAmount").textContent = formatCurrency(
        data.paidAmount || 0
      );

      // Calculate balance if not provided
      const balance = (data.totalFees || 0) - (data.paidAmount || 0);
      document.getElementById("receiptBalance").textContent =
        formatCurrency(balance);

      document.getElementById("receiptExamFees").textContent = data.examFees
        ? formatCurrency(data.examFees)
        : " ";
      document.getElementById("receiptReceivedBy").textContent =
        data.userName || "Administrator";

      // // Show receipt
      // hideAllSections();
      // document.getElementById("separateReceipt").classList.remove("hidden");
    } catch (error) {
      console.error("Error showing receipt:", error);
      Swal.fire("Error", "Could not generate receipt", "error");
      backToSlipForm();
    }
  }

  function showLatestReceipt() {
    if (!lastReceiptData) {
      Swal.fire(
        "Info",
        "No recent receipt available. Please submit a payment first.",
        "info"
      );
      return;
    }
    showReceipt(lastReceiptData);
  }

  function printReceipt() {
    if (!lastReceiptData) {
      Swal.fire("Info", "No receipt data available to print", "info");
      return;
    }

    // Create a clone of the receipt to avoid affecting the original
    const receipt = document.getElementById("separateReceipt").cloneNode(true);
    receipt.classList.remove("hidden");
    receipt.style.display = "block";

    // Create a temporary container for printing
    const printContainer = document.createElement("div");
    printContainer.appendChild(receipt);
    printContainer.style.position = "absolute";
    printContainer.style.left = "-9999px";
    document.body.appendChild(printContainer);

    // Remove print button before printing
    const printBtn = printContainer.querySelector(
      'button[onclick="printReceipt()"]'
    );
    if (printBtn) printBtn.remove();

    // Trigger print
    window.print();

    // Clean up
    document.body.removeChild(printContainer);
  }

  function formatDate(dateString) {
    if (!dateString) return "";
    const date = new Date(dateString);
    return date.toLocaleDateString("en-US", {
      year: "numeric",
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  }
  // This JavaScript would go in your client-side HTML file, within <script> tags.
  document.addEventListener("DOMContentLoaded", function () {
    const logo = document.getElementById("logo-home-link");

    if (logo) {
      logo.addEventListener("click", function () {
        // Call the same function that your "Inquiry Form" sidebar button uses
        // Based on your screenshot, it looks like openInquiryForm()
        if (typeof openInquiryForm === "function") {
          openInquiryForm();
        } else {
          console.error(
            "openInquiryForm() function not found. Please ensure it's defined."
          );
          // Fallback for debugging, or if content is fetched via server
          google.script.run
            .withSuccessHandler(function (htmlContent) {
              document.getElementById("mainContentArea").innerHTML =
                htmlContent; // Assuming a main content div
            })
            .getInquiryFormContent(); // Example of a server-side function
        }
      });
    }
  });

  
  function openInquiryForm() {
    console.log("Inquiry Form button clicked");
    hideAllSections();
    document.getElementById("ifId").classList.remove("hidden"); // Assuming ifId is the inquiry form itself

    // 1. Get the stored branch from the hidden input
    const userBranch = document.getElementById("userBranch").value;

    // 2. Get the branch input element in your inquiry form
    const branchInput = document.getElementById("branch22");

    // 3. Set its value directly
    if (userBranch) {
        branchInput.value = userBranch;
    } else {
        branchInput.value = ""; // Or some default value
    }

    // ⭐ START: Add this section for Inquiry Taken By
    // 4. Get the stored username from the hidden input (loggedInUserId)
    const loggedInUser = document.getElementById("loggedInUserId").value; // Or document.getElementById("userName").value;

    // 5. Get the Inquiry Taken By input element
    const inquiryTakenByInput = document.getElementById("inquiryTakenBy");

    // 6. Set its value directly
    if (loggedInUser) {
        inquiryTakenByInput.value = loggedInUser;
    } else {
        inquiryTakenByInput.value = ""; // Or some default value like "Anonymous"
    }
   
}

  const { jsPDF } = window.jspdf;

  

  // Declare this variable in the global scope of your script.
  let receiptLockTimer = null;

  
  function openAdmissionForm() {
    window.scrollTo(0, 0);
    console.log("Admission Form button clicked");
    hideAllSections();

    const section = document.getElementById("admissionFormSection");
    if (!section) {
      console.error("Admission form section not found!");
      return;
    }
    section.classList.remove("hidden");

    const receiptInput = document.getElementById("receipt_number");
    if (!receiptInput) {
      console.error("Receipt number input field not found!");
      return;
    }

    // 1. Reset the input field's state each time the form is opened.
    receiptInput.readOnly = false;
    receiptInput.value = "Generating..."; // Show immediate feedback.

    // 2. Clear any lingering timers from previous times the form was opened.
    clearTimeout(receiptLockTimer);

    // 3. Call the backend script to fetch the number.
    google.script.run
      .withSuccessHandler(function (newReceiptNumber) {
        // 4. Populate the input field as soon as the number is received.
        receiptInput.value = newReceiptNumber;
        console.log(
          `Populated receipt number: ${newReceiptNumber}. Field will lock in 5 seconds if not edited.`
        );

        // 5. Set a 5-second timer. If it completes, the field becomes read-only.
        receiptLockTimer = setTimeout(() => {
          receiptInput.readOnly = true;
          console.log(`Receipt number ${newReceiptNumber} is now locked.`);
        }, 5000); // 5000 milliseconds = 5 seconds

        // 6. Listen for the *very first* input from the user.
        // The { once: true } option automatically removes the listener after it runs once.
        receiptInput.addEventListener(
          "input",
          () => {
            console.log("User is typing. Cancelling the auto-lock timer.");
            // If the user starts typing, cancel the timer that would have locked the field.
            clearTimeout(receiptLockTimer);
          },
          { once: true }
        );
      })
      .withFailureHandler(function (error) {
        console.error("Error fetching receipt number: " + error.message);
        receiptInput.value = "Error fetching number";
      })
      .getNextReceiptNumber();

    document.getElementById("Student_namee").value =
      sessionStorage.getItem("tempText");

    
  }

  //Handle admission form submission
  document.addEventListener("DOMContentLoaded", function () {
  const admissionBtn = document.getElementById("admissionBtn");
  if (admissionBtn) {
    admissionBtn.addEventListener("click", openAdmissionForm);
  } else {
    console.error("Admission button not found!");
  }
    });
  


  function storePaymentType() {
    const saved = sessionStorage.getItem("paytype");
    console.log("Retrieved paytype from session:", saved);

    if (saved) {
      const radioToSelect = document.querySelector(
        `input[name="payment_type"][value="${saved}"]`
      );
      if (radioToSelect) {
        radioToSelect.checked = true;
        radioToSelect.dispatchEvent(new Event("change")); // trigger onchange like manually selecting it
      } else {
        console.warn("No matching radio found for:", saved);
      }
    }
  }

  // Handle success
 

  

 





function populateInquiryTakenBy() {
    const inquiryTakenByInput = document.getElementById("inquiryTakenBy");
    const branchInput = document.getElementById("branch22"); // Get the branch input

    // Get the logged-in username from the hidden input field that was set during login
    const loggedInUserFromHiddenInput = document.getElementById("loggedInUserId")?.value;
    // Get the logged-in branch from the hidden input field that was set during login
    const loggedInBranchFromHiddenInput = document.getElementById("userBranch")?.value;


    if (inquiryTakenByInput) {
        if (loggedInUserFromHiddenInput) {
            inquiryTakenByInput.value = loggedInUserFromHiddenInput;
            inquiryTakenByInput.readOnly = true; // Ensure it's readonly
        } else {
            inquiryTakenByInput.value = "N/A"; // Or handle anonymous users differently
            console.warn("Logged-in user ID not found in hidden input.");
        }
    }

    if (branchInput) {
        if (loggedInBranchFromHiddenInput) {
            branchInput.value = loggedInBranchFromHiddenInput;
            branchInput.readOnly = true; // Ensure it's readonly
        } else {
            branchInput.value = "N/A"; // Or some default
            console.warn("Logged-in user branch not found in hidden input.");
        }
    }
}
  // Ensure jsPDF is available globally

  document.addEventListener("DOMContentLoaded", function () {
    // Initialize payment type change handler
    document.querySelectorAll('input[name="payment_type"]').forEach((radio) => {
      radio.addEventListener("change", updatePaymentFields);
    });

    // Initialize course year change handler
    document
      .getElementById("courseYears")
      .addEventListener("change", updateYearPaymentOptions);

    // Initialize year payment input handlers (delegated for dynamic elements)
    document
      .getElementById("yearPayments")
      .addEventListener("input", function (event) {
        if (
          event.target.matches('[id^="year"][id$="_paid"]') ||
          event.target.matches('[id^="year"][id$="_installments"]')
        ) {
          calculateDueFees();
        }
      });

    updatePaymentFields(); // Initialize payment fields
    updateCourseDetails(); // Initialize course details
  });

  
  // function updateCourseDetails() {
  //   const select = document.getElementById("courseSelect");
  //   const value = select.value;
  //   const durationDiv = document.getElementById("courseDuration");
  //   const feesDiv = document.getElementById("courseFees");
  //   const yearsSelect = document.getElementById("courseYears");

  //   if (courseData[value]) {
  //     durationDiv.textContent = courseData[value].duration;
  //     feesDiv.textContent = courseData[value].fees;

  //     // Set course years based on duration
  //     if (courseData[value].duration.includes("2")) {
  //       yearsSelect.value = "2";
  //     } else if (courseData[value].duration.includes("3")) {
  //       yearsSelect.value = "3";
  //     } else {
  //       yearsSelect.value = "1";
  //     }
  //   } else {
  //     durationDiv.textContent = "";
  //     feesDiv.textContent = "";
  //     yearsSelect.value = "1"; // Default to 1 year if no course is selected
  //   }
  //   updateYearPaymentOptions(); // Recalculate options based on new years
  // }

  function updatePaymentFields() {
    const paymentType = document.querySelector(
      'input[name="payment_type"]:checked'
    ).value;
    // No need to hide/show `paymentFields` or `emiFields` as they are now combined
    // `yearPayments` will be updated by `updateYearPaymentOptions`
    updateYearPaymentOptions();
  }

  // function updateYearPaymentOptions() {
  //   const courseYears =
  //     parseInt(document.getElementById("courseYears").value) || 0;
  //   const paymentType = document.querySelector(
  //     'input[name="payment_type"]:checked'
  //   ).value;
  //   const yearPaymentsDiv = document.getElementById("yearPayments");
  //   const courseFeesText = document.getElementById("totalCourseFees").textContent;
  //   const courseFees = parseInt(courseFeesText.replace(/[^0-9]/g, "")) || 0;

  //   yearPaymentsDiv.innerHTML = ""; // Clear previous year inputs

  //   if (courseYears > 0) {
  //     for (let i = 1; i <= courseYears; i++) {
  //       const yearDiv = document.createElement("div");
  //       yearDiv.className = "flex items-center mb-2";

  //       if (paymentType === "emi") {
  //         yearDiv.innerHTML = `
  //             <label class="w-1/4">Year ${i} EMI:</label>
  //             <select class="border border-gray-300 rounded px-2 py-1 ml-2" id="year${i}_installments" onchange="calculateInstallment(${i})">
  //               <option value="0">Select Installment</option>
  //               <option value="6">6 Installments</option>
  //               <option value="12">12 Installments</option>
  //             </select>
  //             <input class="border border-gray-300 rounded px-2 py-1 ml-2 w-1/4" id="year${i}_paid" type="number" placeholder="Paid Amount" oninput="calculateDueFees()" value="0">
  //             <span class="ml-2" id="year${i}_due">Due: ₹${courseFees.toFixed(
  //           2
  //         )}</span>
  //           `;
  //       } else {
  //         yearDiv.innerHTML = `
  //             <label class="w-1/4">Year ${i} Fees:</label>
  //             <input class="border border-gray-300 rounded px-2 py-1 ml-2 w-1/4" id="year${i}_total" type="number" placeholder="Total Fees" value="${courseFees}" readonly>
  //             <input class="border border-gray-300 rounded px-2 py-1 ml-2 w-1/4" id="year${i}_paid" type="number" placeholder="Paid Amount" oninput="calculateDueFees()" ${
  //           i > 1 ? "disabled" : ""
  //         } value="0">
  //             <span class="ml-2" id="year${i}_due">Due: ₹${courseFees.toFixed(
  //           2
  //         )}</span>
  //           `;
  //       }
  //       yearPaymentsDiv.appendChild(yearDiv);
  //     }
  //   }
  //   calculateDueFees();
  // }

  function calculateInstallment(year) {
    const installments = parseInt(
      document.getElementById(`year${year}_installments`).value
    );
    const courseFeesText = document.getElementById("totalcourseFees").textContent;
    const totalFees = parseInt(courseFeesText.replace(/[^0-9]/g, "")) || 0;
    let installmentAmount = 0;

    if (installments > 0) {
      installmentAmount = Math.ceil(totalFees / installments);
    }
    document.getElementById(`year${year}_paid`).value =
      installmentAmount.toFixed(2);
    calculateDueFees();
  }

  function calculateDueFees() {
    const courseYears =
      parseInt(document.getElementById("courseYears").value) || 0;
    const paymentType = document.querySelector(
      'input[name="payment_type"]:checked'
    ).value;
    const courseFeesText = document.getElementById("totalcourseFees").textContent;
    const courseFees = parseInt(courseFeesText.replace(/[^0-9]/g, "")) || 0;

    for (let i = 1; i <= courseYears; i++) {
      const paidElement = document.getElementById(`year${i}_paid`);
      const dueElement = document.getElementById(`year${i}_due`);
      let total = courseFees; // Default to courseFees for EMI and partial

      if (paymentType !== "emi") {
        // For full/partial, total is from the readonly input
        const totalElement = document.getElementById(`year${i}_total`);
        if (totalElement) {
          total = parseFloat(totalElement.value) || 0;
        }
      }

      if (paidElement && dueElement) {
        const paid = parseFloat(paidElement.value) || 0;
        let due = total - paid;

        if (paymentType === "emi") {
          const installmentsSelect = document.getElementById(
            `year${i}_installments`
          );
          const selectedInstallments = parseInt(installmentsSelect.value);
          if (selectedInstallments > 0) {
            const totalForYear = courseFees; // Total for EMI is always full course fees for that year
            const installmentPerMonth = (
              totalForYear / selectedInstallments
            ).toFixed(2);
            const paidAmount = parseFloat(paidElement.value) || 0;
            due = totalForYear - paidAmount;
            dueElement.textContent = `Due: ₹${due.toFixed(
              2
            )} (EMI: ${selectedInstallments} x ₹${installmentPerMonth})`;
          } else {
            dueElement.textContent = `Due: ₹${due.toFixed(2)}`;
          }
        } else if (paymentType === "partial" && due > 0) {
          const emiAmount = (due / 11).toFixed(2);
          dueElement.textContent = `Due: ₹${due.toFixed(
            2
          )} (EMI: 11 x ₹${emiAmount})`;
        } else {
          dueElement.textContent = `Due: ₹${due.toFixed(2)}`;
        }

        // Enable next year only if current year is fully paid (for full/partial)
        if (i < courseYears && paymentType !== "emi") {
          const nextPaidElement = document.getElementById(`year${i + 1}_paid`);
          if (nextPaidElement) {
            nextPaidElement.disabled = due > 0;
            if (due > 0) {
              nextPaidElement.value = "";
            }
          }
        }
      }
    }
  }

  

  // Helper functions
  function getValue(id) {
    const element = document.getElementById(id);
    return element ? element.value : "";
  }

  function getDueValue(id) {
    const element = document.getElementById(id);
    return element ? element.textContent.replace(/[^\d.]/g, "") : "";
  }

  function onSuccess(result) {
    Swal.fire({
      title: "Success!",
      text: result.message,
      icon: "success",
      confirmButtonText: "OK",
    }).then(() => {
      generatePDF();
    });
  }

  function onFailure(error) {
    Swal.fire({
      title: "Error!",
      text: error.message,
      icon: "error",
      confirmButtonText: "OK",
    });
  }

  function generatePDF() {
    const element = document.getElementById("slipForm");
    const options = {
      scale: 3,
      useCORS: true,
      letterRendering: true,
      onclone: (clonedDoc) => {
        clonedDoc.querySelectorAll("input, select").forEach((element) => {
          // Apply minimal padding to elements for better PDF rendering
          element.style.paddingTop = "2px";
          element.style.paddingBottom = "2px";
          element.style.paddingLeft = "2px";
          element.style.paddingRight = "2px";
        });
        // Hide buttons and other non-essential elements for the PDF
        clonedDoc.getElementById("submitButton").style.display = "none";
        // Hide radio buttons and checkboxes by setting their container to display: none
        clonedDoc
          .querySelectorAll('input[type="radio"], input[type="checkbox"]')
          .forEach((el) => {
            el.closest("label").style.display = "none";
          });
        // Ensure border-bottom is visible for inputs that use it
        clonedDoc.querySelectorAll(".border-b").forEach((el) => {
          el.style.borderBottomWidth = "1px";
          el.style.borderColor = "black";
        });
      },
    };

    html2canvas(element, options).then((canvas) => {
      const pdf = new jsPDF("p", "mm", "a4");
      const imgWidth = 210; // A4 width in mm
      const pageHeight = 297; // A4 height in mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let position = 0;

      // Calculate the number of pages needed
      const numPages = Math.ceil(imgHeight / pageHeight);

      for (let i = 0; i < numPages; i++) {
        const sX = 0; // start X
        const sY = i * pageHeight * (canvas.width / imgWidth); // start Y based on page
        const sWidth = canvas.width; // slice width
        const sHeight = Math.min(
          pageHeight * (canvas.width / imgWidth),
          canvas.height - sY
        ); // slice height, cap at remaining canvas height

        // Create a temporary canvas to hold the sliced portion
        const sliceCanvas = document.createElement("canvas");
        sliceCanvas.width = sWidth;
        sliceCanvas.height = sHeight;
        const sliceContext = sliceCanvas.getContext("2d");
        sliceContext.drawImage(
          canvas,
          sX,
          sY,
          sWidth,
          sHeight,
          0,
          0,
          sWidth,
          sHeight
        );

        if (i > 0) {
          pdf.addPage();
        }
        pdf.addImage(
          sliceCanvas.toDataURL("image/png"),
          "PNG",
          0,
          0,
          imgWidth,
          (sliceCanvas.height * imgWidth) / sliceCanvas.width
        );
      }

      const studentName =
        document.querySelector('input[name="student_name"]').value || "Student";
      pdf.save(`${studentName}_AdmissionForm.pdf`);
    });
  }
</script>

<script>
  /**
   * Clears all form fields except for the phone number input.
   * This is used to reset the form when a new, unknown number is entered.
   */
  function resetFormFields() {
    console.log("🔄 Resetting form fields.");
    // List of all element IDs to be cleared
    const fieldsToClear = [
      "date", 
      "fullName", 
      "qualification", 
      "age", 
      "whatsappNo", 
      "parentsNo", 
      "email", 
      "address", 
      "interestedCourse", 
      "inquiryTakenBy", 
      "branch22"
    ];

    fieldsToClear.forEach(id => {
      const field = document.getElementById(id);
      if (field) {
        field.value = ""; // Set the value to empty
      }
    });
  }

  // Populate datalist with phone suggestions
  function loadPhoneSuggestions() {
    google.script.run.withSuccessHandler(nums => {
      const dl = document.getElementById("phoneSuggestions");
      if (!dl) return;
      dl.innerHTML = "";
      nums.forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        dl.appendChild(opt);
      });
    }).getAllPhoneNumbers();
  }

  function onPhoneBlur() {
    const rawPhone = document.getElementById("phoneNo").value || "";
    const cleanedPhone = rawPhone.replace(/\D/g, "").trim();

    console.log("📞 Phone entered:", rawPhone, "→ Cleaned:", cleanedPhone);

    if (cleanedPhone.length === 10) {
      google.script.run.withSuccessHandler(function(data) {
        console.log("✅ Data received from Apps Script:", data);
        if (data) {
          // Data FOUND: Populate the form fields
          for (const id in data) {
            const field = document.getElementById(id);
            if (field) {
              field.value = data[id] || ""; // Use empty string as a fallback
            }
          }
        } else {
          // Data NOT FOUND: Alert the user and reset the form
          alert("No record found for this phone number.");
          console.warn("❌ No matching data returned from getStudentData. Clearing form.");
          resetFormFields(); // Call the reset function
        }
      }).getStudentData(cleanedPhone);
    } else {
        // Also a good idea to reset if the input is invalid
        if (rawPhone !== "") { // Only alert if user actually typed something invalid
           alert("Please enter a valid 10-digit phone number.");
           console.warn("❌ Invalid input:", rawPhone);
        }
        // We also reset here to clear the form on any invalid entry
        resetFormFields();
    }
  }

  // Run initial setup when the page is loaded
  window.addEventListener("DOMContentLoaded", () => {
      loadPhoneSuggestions();
      
  });



 // --- Login Form Handling ---
    loginForm.addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent default form submission

      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      console.log("Attempting login for:", username); // Debugging: log username

      // Call the server-side loginUser function
      google.script.run
        .withSuccessHandler(function(response) {
          console.log("Login Response (from server):", response); // Debugging: log server response
          if (response.success) {
            currentLoggedInUser = response.userName; // Store the logged-in user's name
            sessionStorage.setItem('loggedInUser', currentLoggedInUser); // Store in session storage
            console.log("Current Logged In User (after setting):", currentLoggedInUser); // Debugging
            showCustomAlert("Login Successful", `Welcome, ${currentLoggedInUser}!`, true);
            updateUI(); // Update UI after successful login
          } else {
            showCustomAlert("Login Failed", response.error, false);
          }
        })
        .withFailureHandler(function(error) {
          console.error("Login server error:", error);
          showCustomAlert("Error", `An unexpected error occurred during login: ${error.message}`, false);
        })
        .loginUser({ username: username, password: password });
    });



</script>